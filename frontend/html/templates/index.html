<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë²•ë¥  ë¦¬ìŠ¤í¬ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .sidebar { height: 100vh; overflow-y: auto; background: white; border-right: 1px solid #dee2e6; }
        .content-area { height: 100vh; overflow-y: auto; padding: 20px; }
        .risk-high { color: #dc3545; }
        .risk-medium { color: #fd7e14; }
        .risk-low { color: #198754; }
        .chat-box { height: 400px; overflow-y: auto; background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
        .message-user { text-align: right; margin-bottom: 10px; }
        .message-user span { background: #e9ecef; padding: 8px 12px; border-radius: 15px; display: inline-block; }
        .message-ai { text-align: left; margin-bottom: 10px; }
        .message-ai span { background: #d1e7dd; padding: 8px 12px; border-radius: 15px; display: inline-block; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-3 sidebar p-4">
            <h4 class="mb-4">âš–ï¸ ë²•ë¥  ì‹œìŠ¤í…œ</h4>
            <div class="mb-3">
                  <label class="form-label fw-bold">ë²•ë ¹ ì„ íƒ</label>
                  <select id="law-name" class="form-select">
                    <option value="ê±´ì„¤ê¸°ê³„ê´€ë¦¬ë²•">ê±´ì„¤ê¸°ê³„ê´€ë¦¬ë²•</option>
                    <option value="ê±´ì„¤ê¸°ìˆ  ì§„í¥ë²•">ê±´ì„¤ê¸°ìˆ  ì§„í¥ë²•</option>
                    <option value="ê±´ì„¤ì‚°ì—…ê¸°ë³¸ë²•">ê±´ì„¤ì‚°ì—…ê¸°ë³¸ë²•</option>
                    <option value="ê³ ì••ê°€ìŠ¤ ì•ˆì „ê´€ë¦¬ë²•">ê³ ì••ê°€ìŠ¤ ì•ˆì „ê´€ë¦¬ë²•</option>
                    <option value="ëŒ€ê¸°í™˜ê²½ë³´ì „ë²•">ëŒ€ê¸°í™˜ê²½ë³´ì „ë²•</option>
                    <option value="ì‚°ì—…ì•ˆì „ë³´ê±´ë²•" selected>ì‚°ì—…ì•ˆì „ë³´ê±´ë²•</option>
                    <option value="ì†Œë°©ê¸°ë³¸ë²•">ì†Œë°©ê¸°ë³¸ë²•</option>
                    <option value="ì†Œë°©ì‹œì„¤ ì„¤ì¹˜ ë° ê´€ë¦¬ì— ê´€í•œ ë²•ë¥ ">ì†Œë°©ì‹œì„¤ ì„¤ì¹˜ ë° ê´€ë¦¬ì— ê´€í•œ ë²•ë¥ </option>
                    <option value="ì¤‘ëŒ€ì¬í•´ ì²˜ë²Œ ë“±ì— ê´€í•œ ë²•ë¥ ">ì¤‘ëŒ€ì¬í•´ ì²˜ë²Œ ë“±ì— ê´€í•œ ë²•ë¥ </option>
                    <option value="íê¸°ë¬¼ê´€ë¦¬ë²•">íê¸°ë¬¼ê´€ë¦¬ë²•</option>
                  </select>
                </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">1. ì—…ì¢… (Industry)</label>
                <select id="industry" class="form-select">
                    <option value="ì „ì²´ ë³´ê¸°">ì „ì²´ ë³´ê¸°</option>
                    <option value="ê±´ì„¤ì—…">ê±´ì„¤ì—…</option>
                    <option value="ì œì¡°ì—…">ì œì¡°ì—…</option>
                    <option value="í™˜ê²½/ì—ë„ˆì§€">í™˜ê²½/ì—ë„ˆì§€</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">2. ê¸°ì—… ê·œëª¨</label>
                <select id="size" class="form-select">
                    <option value="ê·œëª¨ ì„ íƒ ì•ˆí•¨">ê·œëª¨ ì„ íƒ ì•ˆí•¨</option>
                    <option value="ì†Œê·œëª¨ (5ì¸ ë¯¸ë§Œ)">ì†Œê·œëª¨ (5ì¸ ë¯¸ë§Œ)</option>
                    <option value="ì¤‘ì†Œê·œëª¨ (5ì¸ ~ 50ì¸ ë¯¸ë§Œ)">ì¤‘ì†Œê·œëª¨ (5ì¸ ~ 50ì¸ ë¯¸ë§Œ)</option>
                    <option value="ì¤‘ê²¬ê·œëª¨ (50ì¸ ~ 300ì¸ ë¯¸ë§Œ)">ì¤‘ê²¬ê·œëª¨ (50ì¸ ~ 300ì¸ ë¯¸ë§Œ)</option>
                    <option value="ëŒ€ê·œëª¨ (300ì¸ ì´ìƒ)">ëŒ€ê·œëª¨ (300ì¸ ì´ìƒ)</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">3. ë³´ìœ  ì„¤ë¹„</label>
                <div id="equipment-check">
                    <div class="form-check"><input class="form-check-input eq-chk" type="checkbox" value="í¬ë ˆì¸/ë¦¬í”„íŠ¸"> <label>í¬ë ˆì¸/ë¦¬í”„íŠ¸</label></div>
                    <div class="form-check"><input class="form-check-input eq-chk" type="checkbox" value="ì§€ê²Œì°¨"> <label>ì§€ê²Œì°¨</label></div>
                    <div class="form-check"><input class="form-check-input eq-chk" type="checkbox" value="ì••ë ¥ìš©ê¸°"> <label>ì••ë ¥ìš©ê¸°</label></div>
                    <div class="form-check"><input class="form-check-input eq-chk" type="checkbox" value="ì†Œê°ì‹œì„¤"> <label>ì†Œê°ì‹œì„¤</label></div>
                    <div class="form-check"><input class="form-check-input eq-chk" type="checkbox" value="í™”í•™ë¬¼ì§ˆ ì €ì¥ì†Œ"> <label>í™”í•™ë¬¼ì§ˆ ì €ì¥ì†Œ</label></div>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">4. ìœ„í—˜ë„ í•„í„°</label>
                <div id="risk-check">
                    <div class="form-check"><input class="form-check-input risk-chk" type="checkbox" value="HIGH" checked> <label class="text-danger">HIGH</label></div>
                    <div class="form-check"><input class="form-check-input risk-chk" type="checkbox" value="MEDIUM" checked> <label class="text-warning">MEDIUM</label></div>
                    <div class="form-check"><input class="form-check-input risk-chk" type="checkbox" value="LOW"> <label class="text-success">LOW</label></div>
                </div>
            </div>

            <button onclick="applyFilters()" class="btn btn-primary w-100 mt-3">ì¡°íšŒí•˜ê¸°</button>
            
            <hr>
            <h6>ğŸ¤– Ollama API ì„¤ì •</h6>
            <input type="text" id="api-url" class="form-control mb-2" value="http://localhost:11434/api/generate" placeholder="API URL">
            <input type="text" id="model-name" class="form-control" value="llama3" placeholder="Model Name">
        </div>

        <div class="col-md-9 content-area">
            <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button">ğŸ“Š ë¦¬ìŠ¤í¬ ëŒ€ì‹œë³´ë“œ</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" type="button">ğŸ’¬ AI ë²•ë¥  ìƒë‹´</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="search-tab" data-bs-toggle="tab" data-bs-target="#search" type="button">ğŸ” ë²•ë¥  ê²€ìƒ‰</button>
                </li>
            </ul>

            <div class="tab-content" id="myTabContent">
                
                <div class="tab-pane fade show active" id="dashboard">
                    <div class="row mb-3 text-center">
                        <div class="col"><div class="card p-2"><h5>ğŸ”´ ì¹˜ëª…ì  ìœ„í—˜ <span id="count-high">0</span>ê±´</h5></div></div>
                        <div class="col"><div class="card p-2"><h5>ğŸ¯ ê·œëª¨ ë§ì¶¤ <span id="count-rel">0</span>ê±´</h5></div></div>
                        <div class="col"><div class="card p-2"><h5>ì´ ì¡°íšŒ <span id="count-total">0</span>ê±´</h5></div></div>
                    </div>
                    <div id="law-list" class="accordion">
                        <pre id="out" style="white-space:pre-wrap; border:1px solid #ddd; padding:12px; border-radius:6px; margin-top:12px;"></pre>
                        <div class="text-center mt-5 text-muted">ì¢Œì¸¡ 'ì¡°íšŒí•˜ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
                    </div>
                </div>

                <div class="tab-pane fade" id="chat">
                    <div class="card">
                        <div class="card-header bg-light">AI ë²•ë¥  ìƒë‹´</div>
                        <div class="card-body">
                            <div id="chat-box" class="chat-box mb-3">
                                <div class="message-ai"><span>ì•ˆë…•í•˜ì„¸ìš”! ê¸°ì—… ë²•ë¥  AI ë¹„ì„œì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</span></div>
                            </div>
                            <div class="input-group">
                                <input type="text" id="chat-input" class="form-control" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...">
                                <button class="btn btn-primary" onclick="sendMessage()">ì „ì†¡</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="search">
                  <div class="card">
                    <div class="card-header bg-light">ë²•ë¥  ê²€ìƒ‰</div>
                    <div class="card-body">
                        <div class="row g-2 align-items-end">
                          <div class="col-md-6">
                            <label class="form-label fw-bold">ë²•ë ¹</label>
                            <select id="law-name-search" class="form-select">
                              <option value="ê±´ì„¤ê¸°ê³„ê´€ë¦¬ë²•">ê±´ì„¤ê¸°ê³„ê´€ë¦¬ë²•</option>
                              <option value="ê±´ì„¤ê¸°ìˆ  ì§„í¥ë²•">ê±´ì„¤ê¸°ìˆ  ì§„í¥ë²•</option>
                              <option value="ê±´ì„¤ì‚°ì—…ê¸°ë³¸ë²•">ê±´ì„¤ì‚°ì—…ê¸°ë³¸ë²•</option>
                              <option value="ê³ ì••ê°€ìŠ¤ ì•ˆì „ê´€ë¦¬ë²•">ê³ ì••ê°€ìŠ¤ ì•ˆì „ê´€ë¦¬ë²•</option>
                              <option value="ëŒ€ê¸°í™˜ê²½ë³´ì „ë²•">ëŒ€ê¸°í™˜ê²½ë³´ì „ë²•</option>
                              <option value="ì‚°ì—…ì•ˆì „ë³´ê±´ë²•" selected>ì‚°ì—…ì•ˆì „ë³´ê±´ë²•</option>
                              <option value="ì†Œë°©ê¸°ë³¸ë²•">ì†Œë°©ê¸°ë³¸ë²•</option>
                              <option value="ì†Œë°©ì‹œì„¤ ì„¤ì¹˜ ë° ê´€ë¦¬ì— ê´€í•œ ë²•ë¥ ">ì†Œë°©ì‹œì„¤ ì„¤ì¹˜ ë° ê´€ë¦¬ì— ê´€í•œ ë²•ë¥ </option>
                              <option value="ì¤‘ëŒ€ì¬í•´ ì²˜ë²Œ ë“±ì— ê´€í•œ ë²•ë¥ ">ì¤‘ëŒ€ì¬í•´ ì²˜ë²Œ ë“±ì— ê´€í•œ ë²•ë¥ </option>
                              <option value="íê¸°ë¬¼ê´€ë¦¬ë²•">íê¸°ë¬¼ê´€ë¦¬ë²•</option>
                            </select>
                          </div>
                          <div class="col-md-3">
                            <label class="form-label fw-bold">ë ˆë²¨ (level)</label>
                            <select id="level-search" class="form-select">
                              <option value="">ì „ì²´</option>
                              <option value="ë²•ë¥ ">ë²•ë¥ </option>
                              <option value="ì‹œí–‰ë ¹">ì‹œí–‰ë ¹</option>
                              <option value="ì‹œí–‰ê·œì¹™">ì‹œí–‰ê·œì¹™</option>
                            </select>
                          </div>

                          <div class="col-md-3">
                            <label class="form-label fw-bold">ì¡°ë¬¸ ë²ˆí˜¸ (article_no)</label>
                            <input id="article-no-search" class="form-control" placeholder="ì˜ˆ: 22" />
                          </div>

                          <div class="col-md-3">
                            <button id="search-btn" class="btn btn-primary w-100" onclick="searchLaw()">ê²€ìƒ‰</button>
                          </div>
                        </div>

                        <div id="out-search" class="small text-muted mt-2"></div>

                        <div id="law-search-list" class="accordion mt-3"></div>
                    </div>
                  </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    //ë¦¬ìŠ¤í¬ ëŒ€ì‹œë³´ë“œ
    window.applyFilters = async function () {
      const API_BASE = "http://127.0.0.1:8000";
      const url = `${API_BASE}/analyze`;

      const lawName = document.getElementById("law-name").value;

      const payload = { law_name: lawName };

      const out = document.getElementById("out");
      const listDiv = document.getElementById("law-list");

      out.textContent = "ì¡°íšŒ ì¤‘...";
      listDiv.innerHTML = "";

      try {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const json = await res.json();

        out.textContent = `ì´ ${json.articles.length}ê±´`;
        renderArticles(json.articles); // ğŸ‘‰ ëŒ€ì‹œë³´ë“œìš© ë Œë”ëŸ¬
      } catch (e) {
        out.textContent = "ìš”ì²­ ì‹¤íŒ¨: " + e.message;
        listDiv.innerHTML = '<div class="alert alert-warning">ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      }
    };


    // [ê¸°ëŠ¥ 1] í•„í„°ë§ ìš”ì²­
        function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    // ë²•ë¥  ê²€ìƒ‰
    window.searchLaw = async function () {
      const API_BASE = "http://127.0.0.1:8000";
      const url = `${API_BASE}/analyze`;

      const lawName = document.getElementById("law-name-search").value;
      const articleNoRaw = document.getElementById("article-no-search").value;
      const articleNo = (articleNoRaw || "").trim();

      const level = document.getElementById("level-search").value;

      const payload = {
        law_name: lawName,
        level: level === "" ? null : level,
        article_no: articleNo === "" ? null : articleNo,
      };

      const out = document.getElementById("out-search");
      const btn = document.getElementById("search-btn");
      const listDiv = document.getElementById("law-search-list");

      out.textContent = "ê²€ìƒ‰ ì¤‘...";
      listDiv.innerHTML = "";
      btn.disabled = true;
      btn.textContent = "ê²€ìƒ‰ ì¤‘...";

      try {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const json = await res.json();

        out.textContent = `ì™„ë£Œ: ${(json.articles || []).length}ê±´`;
        renderArticlesInto("law-search-list", json.articles || []);
      } catch (e) {
        out.textContent = "ìš”ì²­ ì‹¤íŒ¨: " + e.message;
        listDiv.innerHTML = '<div class="alert alert-warning">ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      } finally {
        btn.disabled = false;
        btn.textContent = "ê²€ìƒ‰";
      }
    };

    function renderHighlights(highlights, idx) {
      if (!Array.isArray(highlights) || highlights.length === 0) return "";

      const items = highlights
        .map(h => `<li>${escapeHtml(h)}</li>`)
        .join("");

      const hid = `summary-${idx}`;

      return `
        <a class="btn btn-sm btn-outline-primary mt-2"
           data-bs-toggle="collapse"
           href="#${hid}"
           role="button">
          ìš”ì•½ ë³´ê¸°
        </a>

        <div class="collapse mt-2" id="${hid}">
          <div class="border p-2 small">
            <div class="fw-bold mb-1">í•µì‹¬ ë¬¸ì¥ ë°œì·Œ</div>
            <ul class="mb-0">${items}</ul>
          </div>
        </div>
      `;
    }

    // ê²€ìƒ‰ ì•Œê³ ë¦¬ì¦˜
    function renderArticlesInto(listId, articles) {
      const levelRank = (lvl) => {
        if (lvl === "ë²•ë¥ ") return 0;
        if (lvl === "ì‹œí–‰ë ¹") return 1;
        if (lvl === "ì‹œí–‰ê·œì¹™") return 2;
        return 9;
      };

      // âœ… ì •ë ¬ëœ ë°°ì—´ ìƒì„±
      const sorted = [...articles].sort((a, b) => {
        // 1) article_no ìˆ«ì ê¸°ì¤€
        const ai = parseInt(a.article_no ?? "", 10);
        const bi = parseInt(b.article_no ?? "", 10);

        const aNaN = Number.isNaN(ai);
        const bNaN = Number.isNaN(bi);

        if (!aNaN && !bNaN && ai !== bi) return ai - bi;
        if (aNaN && !bNaN) return 1;
        if (!aNaN && bNaN) return -1;

        // 2) ê°™ì€ ì¡°ë¬¸ë²ˆí˜¸ë©´ level ìˆœì„œ
        return levelRank(a.level) - levelRank(b.level);
      });

      const listDiv = document.getElementById(listId);
      listDiv.innerHTML = "";

      if (!Array.isArray(articles) || articles.length === 0) {
        listDiv.innerHTML = '<div class="alert alert-warning">ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      const html = sorted.map((a, idx) => {
        const title = escapeHtml(a.title || "(ì œëª© ì—†ìŒ)");
        const level = escapeHtml(a.level || "");
        const articleNo = escapeHtml(a.article_no || "");
        const content = escapeHtml(a.content || "");
        const highlightsHtml = renderHighlights(a.highlights, idx);

        const collapseId = `content-${idx}`;

        return `
          <div class="card mb-3">
            <div class="card-body">
              <div class="fw-bold mb-1">
                ${articleNo ? `ì œ${articleNo}ì¡°` : ""} ${title}
                <span class="text-muted">(${level})</span>
              </div>

            <div class="mt-2">
              ${highlightsHtml}

              <a class="btn btn-sm btn-outline-secondary mt-2 ms-2"
                 data-bs-toggle="collapse"
                 href="#${collapseId}"
                 role="button">
                ì „ì²´ ì¡°ë¬¸ ë³´ê¸°
              </a>
            </div>

              <div class="collapse mt-2" id="${collapseId}">
                <div class="border p-2 small" style="white-space: pre-wrap;">
                  ${content}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join("");

      listDiv.innerHTML = html;
    }

      // í‘œì‹œìš© ìˆ«ì ì •ë ¬
      const levelRank = (lvl) => {
        if (!lvl) return 9;

        const v = String(lvl).trim();

        if (v === "ë²•ë¥ ") return 0;
        if (v === "ì‹œí–‰ë ¹") return 1;
        if (v === "ì‹œí–‰ê·œì¹™") return 2;

        return 9;
      };

      const sorted = [...articles].sort((a, b) => {
        const ai = parseInt(a.article_no ?? "", 10);
        const bi = parseInt(b.article_no ?? "", 10);

        // 1) article_no ìš°ì„ 
        const aNaN = Number.isNaN(ai);
        const bNaN = Number.isNaN(bi);
        if (!aNaN && !bNaN && ai !== bi) return ai - bi;
        if (aNaN && !bNaN) return 1;
        if (!aNaN && bNaN) return -1;

        // 2) ê°™ì€ ì¡°ë¬¸ë²ˆí˜¸ë©´ level ìš°ì„ ìˆœìœ„
        const ar = levelRank(a.level);
        const br = levelRank(b.level);
        if (ar !== br) return ar - br;

        // 3) ë§ˆì§€ë§‰ tie-breaker: node_id (ì•ˆì • ì •ë ¬)
        return String(a.node_id ?? "").localeCompare(String(b.node_id ?? ""));
      });

      const section = (label, arr) => {
        if (!arr || arr.length === 0) return "";
        const rows = arr
          .map((x) => {
            const ln = escapeHtml(x.law_name ?? "");
            const an = escapeHtml(x.article_no ?? "");
            const tt = escapeHtml(x.title ?? "");
            return `<li><strong>${ln}</strong> ${an ? `ì œ${an}ì¡°` : ""} ${tt}</li>`;
          })
          .join("");
        return `<div class="mt-3"><div class="fw-bold">${label}</div><ul class="mb-0">${rows}</ul></div>`;
      };

      sorted.forEach((item, index) => {
        const lawName = item.law_name ?? "";
        const articleNo = item.article_no ?? "";
        const title = item.title ?? "";
        const content = item.content ?? "";

        const penalties = Array.isArray(item.penalties) ? item.penalties : [];
        const hierarchy = Array.isArray(item.hierarchy) ? item.hierarchy : [];
        const referenceWeak = Array.isArray(item.reference_weak) ? item.reference_weak : [];

        listDiv.innerHTML += `
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${listId}-collapse${index}">
                <strong>[${escapeHtml(lawName)}]</strong>
                &nbsp; ${articleNo ? `ì œ${escapeHtml(articleNo)}ì¡°` : ""}
                &nbsp; ${escapeHtml(title)}
              </button>
            </h2>
            <div id="${listId}-collapse${index}" class="accordion-collapse collapse" data-bs-parent="#${listId}">
              <div class="accordion-body">
                <div style="white-space:pre-wrap;">${escapeHtml(content)}</div>
                ${section("PENALTY_LINK", penalties)}
                ${section("HIERARCHY", hierarchy)}
                ${section("REFERENCE_WEAK", referenceWeak)}
              </div>
            </div>
          </div>
        `;
      });

    function renderAnalyzeResponse(resp) {
      const listDiv = document.getElementById("law-list");
      const out = document.getElementById("out");

      // resp êµ¬ì¡° ê²€ì¦(ì‚¬ì‹¤ ê¸°ë°˜)
      if (!resp || !Array.isArray(resp.articles)) {
        out.textContent = "ì‘ë‹µ í˜•ì‹ì´ ì˜ˆìƒê³¼ ë‹¤ë¦„: " + JSON.stringify(resp, null, 2);
        return;
      }

      // outì—ëŠ” ìµœì†Œ ìƒíƒœë§Œ
      out.textContent = `law_name: ${resp.law_name ?? ""}, articles: ${resp.articles.length}`;

      renderArticles(resp.articles);
    }

    function renderArticles(articles) {
      const listDiv = document.getElementById("law-list");
      listDiv.innerHTML = "";

      if (articles.length === 0) {
        listDiv.innerHTML = '<div class="alert alert-warning">ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        // ì¹´ìš´íŠ¸ëŠ” â€œì´ ì¡°íšŒâ€ë§Œ ì—…ë°ì´íŠ¸(ë¦¬ìŠ¤í¬ ì¹´ìš´íŠ¸ ì‚¬ìš© ê¸ˆì§€)
        document.getElementById("count-total").innerText = "0";
        document.getElementById("count-high").innerText = "0";
        document.getElementById("count-rel").innerText = "0";
        return;
      }

      articles.forEach((item, index) => {
        // itemì˜ í‚¤ ì´ë¦„ì€ queries.py ë°˜í™˜ êµ¬ì¡°ì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë‹ˆ ë°©ì–´ì ìœ¼ë¡œ ì²˜ë¦¬
        const lawName = item.law_name ?? item.law ?? "";
        const articleNo = item.article_no ?? item.article ?? item.articleNum ?? "";
        const title = item.title ?? "";
        const content = item.content ?? "";

        // ì—°ê²° ë¦¬ìŠ¤íŠ¸(ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì¶œë ¥)
        const penalties = Array.isArray(item.penalties) ? item.penalties : [];
        const hierarchy = Array.isArray(item.hierarchy) ? item.hierarchy : [];
        const referenceWeak = Array.isArray(item.reference_weak) ? item.reference_weak : [];

        const section = (label, arr) => {
          if (!arr || arr.length === 0) return "";
          const rows = arr.map((x) => {
            const ln = escapeHtml(x.law_name ?? x.law ?? "");
            const an = escapeHtml(x.article_no ?? x.article ?? "");
            const tt = escapeHtml(x.title ?? "");
            return `<li><strong>${ln}</strong> ${an ? `ì œ${an}ì¡°` : ""} ${tt}</li>`;
          }).join("");
          return `<div class="mt-3"><div class="fw-bold">${label}</div><ul class="mb-0">${rows}</ul></div>`;
        };

        const html = `
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                <strong>[${escapeHtml(lawName || "")}]</strong>
                &nbsp; ${articleNo ? `ì œ${escapeHtml(articleNo)}ì¡°` : ""}
                &nbsp; ${escapeHtml(title)}
              </button>
            </h2>
            <div id="collapse${index}" class="accordion-collapse collapse" data-bs-parent="#law-list">
              <div class="accordion-body">
                <div style="white-space:pre-wrap;">${escapeHtml(content)}</div>
                ${section("PENALTY_LINK (ëª…ì‹œì  ë²Œì¹™ ì—°ê²°)", penalties)}
                ${section("HIERARCHY (ìƒÂ·í•˜ìœ„)", hierarchy)}
                ${section("REFERENCE_WEAK (ë²•ì  íš¨ê³¼ ì—†ìŒ)", referenceWeak)}
              </div>
            </div>
          </div>
        `;

        listDiv.innerHTML += html;
      });

      // âœ… ì¹´ìš´íŠ¸ëŠ” â€œì´ ì¡°íšŒâ€ë§Œ ì˜ë¯¸ ìˆê²Œ ì—…ë°ì´íŠ¸ (ë‚˜ë¨¸ì§€ëŠ” 0 ê³ ì •)
      document.getElementById("count-total").innerText = String(articles.length);
      document.getElementById("count-high").innerText = "0";
      document.getElementById("count-rel").innerText = "0";
    }
    // [ê¸°ëŠ¥ 2] ë²•ë¥  ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    function renderLaws(data) {
        const listDiv = document.getElementById('law-list');
        listDiv.innerHTML = '';

        let highCount = 0;
        let relCount = 0;

        if (data.length === 0) {
            listDiv.innerHTML = '<div class="alert alert-warning">ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        data.forEach((item, index) => {
            if (item.risk_level === 'HIGH') highCount++;
            if (item.is_relevant) relCount++;

            let icon = item.risk_level === 'HIGH' ? 'ğŸ”´' : item.risk_level === 'MEDIUM' ? 'ğŸŸ ' : 'ğŸŸ¢';
            let badge = item.is_relevant ? '<span class="badge bg-primary ms-2">ğŸ¯ ê·œëª¨ ê´€ë ¨</span>' : '';
            
            const html = `
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                            ${icon} ${badge} &nbsp; <strong>[${item.law_name}] ì œ${item.article_no}ì¡°</strong> &nbsp; ${item.title}
                        </button>
                    </h2>
                    <div id="collapse${index}" class="accordion-collapse collapse" data-bs-parent="#law-list">
                        <div class="accordion-body">
                            <p>${item.content_html}</p> ${item.risk_evidence ? `<div class="text-muted small mt-2">ğŸ” ê·¼ê±°: ${item.risk_evidence}</div>` : ''}
                        </div>
                    </div>
                </div>
            `;
            listDiv.innerHTML += html;
        });

        // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
        document.getElementById('count-high').innerText = highCount;
        document.getElementById('count-rel').innerText = relCount;
        document.getElementById('count-total').innerText = data.length;
    }

    // [ê¸°ëŠ¥ 3] ì±„íŒ… ì „ì†¡
    async function sendMessage() {
        const input = document.getElementById('chat-input');
        const prompt = input.value;
        if (!prompt) return;

        const chatBox = document.getElementById('chat-box');
        
        // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
        chatBox.innerHTML += `<div class="message-user"><span>${prompt}</span></div>`;
        input.value = '';
        chatBox.scrollTop = chatBox.scrollHeight;

        // ë¡œë”© í‘œì‹œ
        const loadingId = 'loading-' + Date.now();
        chatBox.innerHTML += `<div class="message-ai" id="${loadingId}"><span>ğŸ” ê²€ìƒ‰ ë° ë‹µë³€ ì¤‘...</span></div>`;

        // API í˜¸ì¶œ
        const apiUrl = document.getElementById('api-url').value;
        const modelName = document.getElementById('model-name').value;

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ prompt, api_url: apiUrl, model: modelName })
            });
            const result = await response.json();
            
            // ë¡œë”© ì œê±° í›„ ë‹µë³€ í‘œì‹œ
            document.getElementById(loadingId).remove();
            chatBox.innerHTML += `<div class="message-ai"><span>${result.response}</span></div>`;
            if(result.context) {
                 chatBox.innerHTML += `<div class="message-ai"><small class="text-muted">ì°¸ê³  ë²•ë ¹:<br>${result.context.replace(/\n/g, '<br>')}</small></div>`;
            }

        } catch (error) {
            document.getElementById(loadingId).innerHTML = `<span>âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}</span>`;
        }
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>

</body>
</html>
